<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <title>Firebase Realtime Database Viewer with Save Option</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        th, td {
            text-align: center;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #printable {
                visibility: visible;
                position: absolute;
                left: 0;
                top: 0;
                font-size: 120%;
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <h1>Firebase Realtime Database Viewer</h1>
    <button id="saveIcon" title="Save Table" style="font-size: 12px; cursor: pointer;">💾 Save Table</button>
    <label for="dateFilter">Filter by Date:</label>
    <select id="dateFilter">
        <option value="all">All Dates</option>
    </select>
    <button id="enableSoundButton">Click to Enable Sound</button>
    <table id="dataTable" border="1" cellpadding="5" cellspacing="0">
        <thead>
            <tr>
                <th>Number</th>
                <th>Date</th>
                <th>Timestamp</th>
                <th>Table Number</th>
                <th>Order List</th>
                <th>Qty</th>
                <th>Total Amount</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <audio id="notificationSound" src="notification.mp3" preload="auto"></audio>
    <div id="printable" style="display:none;"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBltwkIkocgAMya7_lKglLVikl9dIzegoI",
            authDomain: "seoulchicken-fa390.firebaseapp.com",
            databaseURL: "https://seoulchicken-fa390-default-rtdb.firebaseio.com",
            projectId: "seoulchicken-fa390",
            storageBucket: "seoulchicken-fa390.appspot.com",
            messagingSenderId: "159382576680",
            appId: "1:159382576680:web:8d5440ea41ba4cb89d9f1d",
            measurementId: "G-FRCNM1T9JB"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database(app);

        const dateFilter = document.getElementById('dateFilter');
        const tableBody = document.querySelector('#dataTable tbody');
        const notificationSound = document.getElementById('notificationSound');
        const enableSoundButton = document.getElementById('enableSoundButton');

        let soundEnabled = false;
        let count = 1;
        let allData = [];

        enableSoundButton.addEventListener('click', () => {
            soundEnabled = true;
            enableSoundButton.style.display = 'none';
        });

        function saveTableAsCSV() {
            const rows = document.querySelectorAll("#dataTable tr");
            let csvContent = "\uFEFF"; // BOM 추가로 UTF-8 인코딩 보장

            rows.forEach(row => {
                const cells = row.querySelectorAll("th, td");
                const rowData = Array.from(cells).map(cell => `"${cell.textContent.trim()}"`).join(",");
                csvContent += rowData + "\n";
            });

            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "table_data.csv";
            a.click();
            URL.revokeObjectURL(url);
        }

        document.getElementById("saveIcon").addEventListener("click", saveTableAsCSV);

        function displayData(key, data) {
            const row = document.createElement('tr');

            const number = count++;
            const tableNumber = data.tableNumber || '';
            const timestamp = data.timestamp || '';

            const dateObj = new Date(timestamp);
            const date = dateObj.toLocaleDateString('ko-KR', { timeZone: 'Asia/Seoul' });
            const time = dateObj.toLocaleTimeString('ko-KR', { timeZone: 'Asia/Seoul' });

            let orderList = data.orderList ? JSON.stringify(data.orderList) : '';
            orderList = orderList.replace(/"name":\s*".*?",?/g, ''); // "name" 제거
            orderList = orderList.replace(/[\[\]{}"]+/g, '').split(',').join('<br>');

            const totalAmount = data.totalAmount || '';

            const cells = [
                number, date, time, tableNumber, orderList, '', totalAmount
            ].map(content => {
                const cell = document.createElement('td');
                cell.innerHTML = content;
                return cell;
            });

            cells.forEach(cell => row.appendChild(cell));
            tableBody.insertBefore(row, tableBody.firstChild);
        }

        function loadDataFromFirebase() {
            const dbRef = database.ref('orders');
            dbRef.once('value', (snapshot) => {
                const data = snapshot.val();
                const sortedKeys = Object.keys(data).sort((a, b) => new Date(data[b].timestamp) - new Date(data[a].timestamp));

                sortedKeys.forEach((key) => {
                    if (!allData.some(item => item.key === key)) {
                        allData.push({ key, data: data[key] });
                        displayData(key, data[key]);
                    }
                });
            });
        }

        window.onload = function() {
            loadDataFromFirebase();
        };

    </script>
</body>
</html>
